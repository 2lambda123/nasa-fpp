#!/bin/sh

. ../../../scripts/test-utils.sh

fpp_to_json=../../../bin/fpp-to-json

update()
{
  args=$1
  infile=$2
  if test -n "$3"
  then
    outfile=$3
  else
    outfile=$infile
  fi
  echo "updating ref files for $outfile"

  refs_folder=_$outfile.refs
  mkdir -p $refs_folder

  $fpp_to_json $infile.fpp $args 2>&1
  
  remove_path_prefix < fpp-ast.json > $refs_folder/$outfile.ast.ref.txt
  remove_path_prefix < fpp-loc-map.json > $refs_folder/$outfile.loc-map.ref.txt

  if [ "$args" = "-s" ]; then
    rm fpp-ast.json fpp-loc-map.json
  
  else
    remove_path_prefix < fpp-analysis.json > $refs_folder/$outfile.analysis.ref.txt
    # Delete the JSON files
    rm fpp-ast.json fpp-loc-map.json fpp-analysis.json
  fi
}

rm -rf *.refs

update "" activeComponents
update "" commands
update "" constTypesComponents
update "" constants
update "" enums
update "" events
update "" importedTopologies
update "" internalPorts
update "" matchedPorts
update "" modules
update "" parameters
update "" passiveComponent
update "Fw/symbols.fpp" patternedConnections
update "" ports
update "" queuedComponents
update "" simpleComponents
update "" simpleTopology
update "" specialPorts
update "" telemetry
update "" types
update "-s" syntaxOnly

