#!/bin/sh

cd `dirname $0`

fprime_gcc=../../../../../scripts/fprime-gcc
export FPRIME_GCC_FLAGS="-I../../fprime"
warning_flags="
-Wno-gnu-zero-variadic-macro-arguments
-Wno-return-type
-Wno-sign-conversion
-Wno-unused-parameter
"
include_flags="
-I$FPRIME/gtest/googletest-src/googletest/include
-I..
-I../../../..
-I../base
-I../impl
-I../test-base
"
define_flags="-DPROTECTED="public" -DBUILD_UT=1"

../../fprime/generate_cpp

# Generate headers in base and test-base
for dir in base test-base
do
  echo "running the tests in ../$dir to generate the header files"
  (cd ../$dir; ./run)
done

echo "copying base headers to test-base"
cp ../base/*Ac.hpp ../test-base

# Generate impl headers in impl
echo "generating impl headers in impl"
for file in `ls ../impl/*.ref.hpp`
do
  base=`basename $file .ref.hpp | sed 's/\.template//'`
  cp $file ../impl/$base.hpp
done

# Generate header files
echo "generating header files"
for file in `ls *.ref.hpp`
do
  base=`basename $file .ref.hpp`
  cp $file $base.hpp
done

# Comile cpp files
for file in `find . -name '*.ref.cpp' | sort`
do
  base=`basename $file .ref.cpp`
  cp $file $base.cpp
  echo "compiling $base.cpp"
  $fprime_gcc $include_flags -c $define_flags $warning_flags $base.cpp
done
